[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Project",
  "enabled": 1,
  "modified": "2025-12-08 12:49:39.321307",
  "module": "Frappe Project",
  "name": "Project Gantt",
  "script": "frappe.ui.form.on('Project', {\r\n    refresh(frm) {\r\n\r\n        // -----------------------------\r\n        // CLEAN + SETUP GANTT CONTAINER\r\n        // -----------------------------\r\n        if (frm.fields_dict.gantt_html) {\r\n            frm.fields_dict.gantt_html.$wrapper.empty();\r\n            frm.fields_dict.gantt_html.$wrapper.css({\r\n                padding: \"0\",\r\n                margin: \"0\"\r\n            });\r\n        }\r\n\r\n        const gantt_container_id = \"project-gantt-container\";\r\n        frm.fields_dict.gantt_html.$wrapper.html(`\r\n            <div id=\"${gantt_container_id}\"\r\n                 class=\"gantt-container\"\r\n                 style=\"height:600px; border:1px solid #ddd; overflow-x:auto; overflow-y:hidden;\">\r\n            </div>\r\n        `);\r\n\r\n        if (!frm.doc.name) return;\r\n\r\n        load_gantt_lib().then(() => load_tasks_and_render(frm, gantt_container_id));\r\n    }\r\n});\r\n\r\n// -------------------------------------------------------\r\n//  FETCH TASKS + RENDER GANTT\r\n// -------------------------------------------------------\r\nfunction load_tasks_and_render(frm, gantt_container_id) {\r\n\r\n    frappe.call({\r\n        method: 'frappe.client.get_list',\r\n        args: {\r\n            doctype: 'ToDo',\r\n            fields: [\r\n                'name',\r\n                'description',\r\n                'custom_start_date',\r\n                'date',  // <-- END DATE IS THIS FIELD\r\n                'custom_percentage_complete'\r\n            ],\r\n            filters: { custom_project: frm.doc.name },\r\n            limit_page_length: 500\r\n        }\r\n    }).then(res => {\r\n\r\n        const rows = res.message || [];\r\n\r\n        if (!rows.length) {\r\n            document.getElementById(gantt_container_id).innerHTML =\r\n                `<p style=\"padding:10px;\">No tasks found for this project.</p>`;\r\n            return;\r\n        }\r\n\r\n        // -------------------------------------\r\n        // Convert ToDos → Gantt task structure\r\n        // -------------------------------------\r\n        const tasks = rows.map(t => {\r\n            let start = t.custom_start_date;\r\n            let end = t.date;  // <-- USING STANDARD TODO.DATE\r\n\r\n            // fallback: if end missing, make it 1-day\r\n            if (start && !end) end = frappe.datetime.add_days(start, 1);\r\n\r\n            // fallback: if start missing but end exists\r\n            if (!start && end) start = frappe.datetime.add_days(end, -1);\r\n\r\n            // fallback: both missing → default 1-day\r\n            if (!start && !end) {\r\n                start = frappe.datetime.get_today();\r\n                end = frappe.datetime.add_days(start, 1);\r\n            }\r\n\r\n            return {\r\n                id: t.name,\r\n                name: t.description || t.name,\r\n                start,\r\n                end,\r\n                progress: t.custom_percentage_complete || 0\r\n            };\r\n        });\r\n\r\n        // -------------------------------------\r\n        // CREATE GANTT\r\n        // -------------------------------------\r\n        const gantt = new Gantt(`#${gantt_container_id}`, tasks, {\r\n            view_mode: 'Day',\r\n            bar_height: 28,\r\n            column_width: 40\r\n        });\r\n\r\n        gantt.bind_bar_events();\r\n\r\n        setTimeout(() => {\r\n            apply_custom_colors();\r\n            scroll_to_start_of_week(gantt);\r\n        }, 80);\r\n    });\r\n}\r\n\r\n// -------------------------------------------------------\r\n//  BAR COLOR PATCH (dark base + blue progress)\r\n// -------------------------------------------------------\r\nfunction apply_custom_colors() {\r\n\r\n    // Base duration bar\r\n    document.querySelectorAll('.bar-wrapper .bar').forEach(bar => {\r\n        bar.style.fill = '#444';\r\n        bar.setAttribute('fill', '#444');\r\n        bar.removeAttribute('filter');\r\n        bar.removeAttribute('mask');\r\n        bar.style.filter = 'none';\r\n    });\r\n\r\n    // Progress overlay\r\n    document.querySelectorAll('.bar-wrapper .bar-progress').forEach(prog => {\r\n        prog.style.fill = '#007bff';\r\n        prog.setAttribute('fill', '#007bff');\r\n        prog.style.opacity = '1';\r\n        prog.removeAttribute('filter');\r\n        prog.removeAttribute('mask');\r\n        prog.style.filter = 'none';\r\n    });\r\n}\r\n\r\n// -------------------------------------------------------\r\n//  AUTO-SCROLL TO START OF CURRENT WEEK\r\n// -------------------------------------------------------\r\nfunction scroll_to_start_of_week(gantt) {\r\n    const container = document.querySelector('.gantt-container');\r\n    if (!container) return;\r\n\r\n    const startOfWeek = moment().startOf('week');  // Monday\r\n    const diffDays = moment().diff(startOfWeek, 'days');\r\n    const px = diffDays * gantt.options.column_width;\r\n\r\n    container.scrollLeft = px;\r\n}\r\n\r\n// -------------------------------------------------------\r\n//  LOAD GANTT LIBRARY (CDN)\r\n// -------------------------------------------------------\r\nfunction load_gantt_lib() {\r\n    return new Promise(resolve => {\r\n\r\n        if (window.Gantt) {\r\n            resolve();\r\n            return;\r\n        }\r\n\r\n        // Script\r\n        if (!document.querySelector('script[src*=\"frappe-gantt.umd.js\"]')) {\r\n            let script = document.createElement(\"script\");\r\n            script.src = \"https://cdn.jsdelivr.net/npm/frappe-gantt/dist/frappe-gantt.umd.js\";\r\n            script.onload = resolve;\r\n            document.head.appendChild(script);\r\n        }\r\n\r\n        // CSS\r\n        if (!document.querySelector('link[href*=\"frappe-gantt.css\"]')) {\r\n            let link = document.createElement(\"link\");\r\n            link.rel = \"stylesheet\";\r\n            link.href = \"https://cdn.jsdelivr.net/npm/frappe-gantt/dist/frappe-gantt.css\";\r\n            document.head.appendChild(link);\r\n        }\r\n\r\n        // Fallback polling\r\n        let tries = 0;\r\n        let int = setInterval(() => {\r\n            if (window.Gantt) {\r\n                clearInterval(int);\r\n                resolve();\r\n            }\r\n            if (tries++ > 50) clearInterval(int);\r\n        }, 100);\r\n    });\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Project",
  "enabled": 0,
  "modified": "2025-12-07 15:56:26.826026",
  "module": "Frappe Project",
  "name": "Project Tasks Dashboard",
  "script": "frappe.ui.form.on('Project', {\n    refresh: function(frm) {\n        const section_fieldname = 'todo_section';\n        const style_id = 'project-tasks-styles-left';\n\n        // Inject scoped styles once\n        if (!document.getElementById(style_id)) {\n            const styles = `\n                .project-tasks { margin-top: .25rem; }\n\n                .project-tasks__title {\n                    display: flex;\n                    justify-content: space-between;\n                    align-items: baseline;\n                    margin: .25rem 0 .5rem;\n                }\n                .project-tasks__title .h6 {\n                    margin: 0;\n                    font-weight: 600;\n                    text-transform: uppercase;\n                    letter-spacing: .02em;\n                    color: var(--text-muted, #6b7280);\n                }\n                .project-tasks__meta { font-size: 12px; color: var(--text-muted, #6b7280); }\n\n                /* Shared grid: all left-aligned (Description, Allocated To, Priority, Status, Due) */\n                .project-tasks__grid {\n                    display: grid;\n                    grid-template-columns: 5fr 3fr 2fr 2fr 2fr;\n                    align-items: center;\n                    gap: .5rem;\n                }\n                .project-tasks__cell {\n                    min-width: 0;          /* enables ellipsis */\n                    line-height: 1.25;      /* consistent baseline */\n                    text-align: left;       /* left align everything */\n                    white-space: nowrap;    /* prevent wrapping within cells */\n                }\n                .project-tasks__cell .indicator { vertical-align: middle; }\n\n                /* Header */\n                .project-tasks__head {\n                    border-bottom: 1px solid var(--border-color, #e5e7eb);\n                    padding: .375rem .25rem;\n                }\n                .project-tasks__head .project-tasks__cell {\n                    font-weight: 600;\n                    color: var(--text-color, #111827);\n                    font-size: 12px;\n                }\n\n                /* Rows */\n                .project-tasks__row {\n                    padding: .5rem .25rem;\n                    border-bottom: 1px solid var(--border-color, #eef2f7);\n                }\n                .project-tasks__row:last-child { border-bottom: 0; }\n\n                /* Priority badge (compact, consistent height) */\n                .project-tasks__badge {\n                    display: inline-block;\n                    background: #f3f4f6;\n                    color: #374151;\n                    border-radius: 10px;\n                    padding: 2px 8px;\n                    font-size: 11px;\n                    line-height: 1.2;\n                }\n\n                /* Assignee pill */\n                .project-tasks__assignee {\n                    display: inline-block;\n                    color: var(--text-color, #111827);\n                    max-width: 100%;\n                }\n\n                /* Links */\n                .project-tasks a { color: var(--text-color, #111827); text-decoration: none; }\n                .project-tasks a:hover { text-decoration: underline; }\n\n                /* Footer */\n                .project-tasks__footer { margin-top: .5rem; text-align: right; }\n\n                /* Empty state */\n                .project-tasks__empty { margin: .5rem 0; color: var(--text-muted, #6b7280); font-size: 12px; }\n            `;\n            $('<style>', { id: style_id, html: styles }).appendTo('head');\n        }\n\n        // Ensure section\n        if (!frm.fields_dict[section_fieldname]) {\n            frm.add_section(__('Project Tasks'), section_fieldname);\n            frm.add_custom_button(__('Project Tasks'), () => {\n                frappe.set_route('List', 'ToDo', { 'custom_project': frm.doc.name });\n            }, __('View'));\n        } else {\n            frm.set_df_property(section_fieldname, 'hidden', 0);\n        }\n\n        render_todos(frm, section_fieldname);\n\n        function render_todos(frm, fieldname) {\n            const $container = $(frm.fields_dict[fieldname].wrapper);\n\n            $container.empty().html(`\n                <div class=\"project-tasks list-view\">\n                    <div class=\"list-view-content\">\n                        <div class=\"project-tasks__title\">\n                            <div class=\"h6\">${__('Project Tasks')}</div>\n                            <div class=\"project-tasks__meta\">${__('Loading…')}</div>\n                        </div>\n                        <div class=\"text-center text-muted\">\n                            <i class=\"fa fa-spinner fa-spin fa-fw\"></i>\n                        </div>\n                    </div>\n                </div>\n            `);\n\n            frappe.call({\n                method: \"frappe.client.get_list\",\n                args: {\n                    doctype: \"ToDo\",\n                    filters: {\n                        \"custom_project\": frm.doc.name,\n                        \"docstatus\": 0,\n                        \"status\": [\"!=\", \"Done\"]\n                    },\n                    fields: [\"name\", \"description\", \"status\", \"priority\", \"date\", \"allocated_to\"],\n                    order_by: \"priority DESC, date ASC\",\n                    limit: 10\n                },\n                callback: function(r) {\n                    const $content = $container.find('.list-view-content');\n                    $content.empty();\n\n                    const todos = (r.message || []).map(t => {\n                        const description_text = frappe.utils.html2text\n                            ? frappe.utils.html2text(t.description || '')\n                            : $('<div>').html(t.description || '').text();\n                        const due = t.date ? frappe.datetime.str_to_user(t.date) : '';\n                        // Friendly assignee name if possible\n                        let assignee = t.allocated_to || '';\n                        try {\n                            if (assignee && frappe.user_info) {\n                                const info = frappe.user_info(assignee);\n                                assignee = (info && info.full_name) ? info.full_name : assignee;\n                            }\n                        } catch (e) {\n                            // fallback to raw value\n                        }\n                        return { ...t, description_text, due, assignee };\n                    });\n\n                    // Title with count and \"View all\"\n                    $content.append(`\n                        <div class=\"project-tasks__title\">\n                            <div class=\"h6\">${__('Project Tasks')}</div>\n                            <div class=\"project-tasks__meta\">\n                                ${todos.length} ${__('open')}\n                                &nbsp;&middot;&nbsp;\n                                <a class=\"small text-muted\" href=\"/app/todo?custom_project=${encodeURIComponent(frm.doc.name)}\">\n                                    ${__('View all')}\n                                </a>\n                            </div>\n                        </div>\n                    `);\n\n                    if (!todos.length) {\n                        $content.append(`\n                            <div class=\"project-tasks__empty\">\n                                ${__('No open ToDos linked to this project.')}\n                                <a class=\"small\" href=\"/app/todo/new?custom_project=${encodeURIComponent(frm.doc.name)}\">\n                                    ${__('Create a task')}\n                                </a>\n                            </div>\n                        `);\n                        return;\n                    }\n\n                    // Header (left-aligned)\n                    $content.append(`\n                        <div class=\"list-row project-tasks__head\">\n                            <div class=\"project-tasks__grid\">\n                                <div class=\"project-tasks__cell\">${__('Description')}</div>\n                                <div class=\"project-tasks__cell\">${__('Allocated To')}</div>\n                                <div class=\"project-tasks__cell\">${__('Priority')}</div>\n                                <div class=\"project-tasks__cell\">${__('Status')}</div>\n                                <div class=\"project-tasks__cell\">${__('Due date')}</div>\n                            </div>\n                        </div>\n                    `);\n\n                    const indicatorColor = (status) => ({\n                        'Open': 'orange',\n                        'Priority': 'red',\n                        'To Do': 'orange',\n                        'In Progress': 'blue',\n                        'Waiting': 'darkgrey'\n                    }[status] || 'gray');\n\n                    // Rows (left-aligned to match header)\n                    todos.forEach(todo => {\n                        const status_badge = `\n                            <span class=\"indicator ${indicatorColor(todo.status)} indicator-sm\">\n                                ${frappe.utils.escape_html(todo.status || '')}\n                            </span>\n                        `;\n\n                        $content.append(`\n                            <div class=\"list-row project-tasks__row\" data-name=\"${frappe.utils.escape_html(todo.name)}\">\n                                <div class=\"project-tasks__grid\">\n                                    <div class=\"project-tasks__cell ellipsis\">\n                                        <a href=\"/app/todo/${encodeURIComponent(todo.name)}\"\n                                           title=\"${frappe.utils.escape_html(todo.description_text)}\">\n                                            ${frappe.utils.escape_html(todo.description_text)}\n                                        </a>\n                                    </div>\n                                    <div class=\"project-tasks__cell ellipsis\">\n                                        <span class=\"project-tasks__assignee\" title=\"${frappe.utils.escape_html(todo.assignee || '')}\">\n                                            ${frappe.utils.escape_html(todo.assignee || '')}\n                                        </span>\n                                    </div>\n                                    <div class=\"project-tasks__cell\">\n                                        <span class=\"project-tasks__badge\">\n                                            ${frappe.utils.escape_html(todo.priority || '')}\n                                        </span>\n                                    </div>\n                                    <div class=\"project-tasks__cell\">\n                                        ${status_badge}\n                                    </div>\n                                    <div class=\"project-tasks__cell\">\n                                        ${frappe.utils.escape_html(todo.due)}\n                                    </div>\n                                </div>\n                            </div>\n                        `);\n                    });\n\n                    // Footer\n                    $content.append(`\n                        <div class=\"project-tasks__footer\">\n                            <a class=\"small\" href=\"/app/todo?custom_project=${encodeURIComponent(frm.doc.name)}\">\n                                ${__('View all tasks')}\n                            </a>\n                        </div>\n                    `);\n                }\n            });\n        }\n    }\n});",
  "view": "Form"
 }
]